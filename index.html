// Este é o final COMPLETO do script que foi cortado na parte 2.
// Ele começa com o fechamento da função 'returnWordToContainer'.

        if (e.target.classList.contains('draggable-words-container') && draggable && draggable.parentElement.classList.contains('drop-zone')) {
            e.target.appendChild(draggable); // Move a palavra de volta
            draggable.classList.remove('dragging');
            draggable.style.cursor = 'grab'; // Restaura o cursor
        }
    } // <-- Fim da função returnWordToContainer

    // FUNÇÃO QUE CHECA O TÓPICO 8
    function checkDragAndDrop(q) {
        let allCorrect = true;
        document.querySelectorAll('.drop-zone').forEach(dropZone => {
            const sentenceId = dropZone.getAttribute('data-sentence-id');
            const correctWord = dropZone.getAttribute('data-correct-word');
            const sentenceData = q.data.sentences.find(s => s.id === sentenceId);
            
            dropZone.classList.remove('correct', 'incorrect');
            dropZone.style.pointerEvents = 'none'; // Desativa interação após a checagem

            if (dropZone.children.length === 0) {
                // Resposta vazia
                dropZone.classList.add('incorrect');
                dropZone.innerHTML = `<span class="correct-highlight">${correctWord}</span>`;
                allCorrect = false;
                return;
            }

            const placedWord = dropZone.children[0];
            placedWord.draggable = false;
            
            if (placedWord.textContent === correctWord) {
                dropZone.classList.add('correct');
                sentenceData.isCorrect = true;
            } else {
                dropZone.classList.add('incorrect');
                allCorrect = false;
                // Mostra a resposta correta e move a palavra incorreta de volta
                dropZone.innerHTML += `<span class="correct-highlight"> (${correctWord})</span>`;
                // Move a palavra incorreta de volta para o pool
                document.querySelector('.draggable-words-container').appendChild(placedWord);
                placedWord.style.cursor = 'grab';
            }
        });

        document.querySelectorAll('.draggable-word').forEach(word => word.draggable = false); // Desativa as palavras restantes
        
        if (allCorrect) {
            feedback.innerHTML = '<span style="color: #28a745; font-size: 1.2em;">All answers are correct! Click Next.</span>';
        } else {
            feedback.innerHTML = '<span style="color: #dc3545; font-size: 1.2em;">Review the incorrect answers and click Next.</span>';
        }
    } // <-- Fim da função checkDragAndDrop

    // --- FUNÇÃO PRINCIPAL DE CARREGAMENTO ---
    function loadQuestion(q) {
        answerChecked = false; // Reseta o estado para a nova pergunta
        feedback.innerHTML = '';
        questionText.style.display = 'block'; // Garante que o texto da pergunta esteja visível por padrão
        document.getElementById('pronunciation-container').style.display = 'none'; // Esconde containers de exercícios
        optionsContainer.style.justifyContent = 'initial'; // Reseta o alinhamento
        
        questionText.innerHTML = q.question;
        progressIndicator.textContent = `Topic ${currentQuestionIndex + 1}/${lessonQuestions.length}`;
        document.querySelector('h1').textContent = `Beginner ${currentChapter}: ${q.title}`; // Atualiza o título

        if (q.image) {
            questionImage.src = GITHUB_RAW_BASE_URL + q.image;
            questionImage.style.display = 'block';
        } else {
            questionImage.style.display = 'none';
        }
        
        switch (q.correctAnswer) {
            case 'INFO_TABLE':
                loadInfoTable(q);
                break;
            case 'PRONUNCIATION_SET':
                loadPronunciationSlide(q);
                break;
            case 'INTERACTIVE_BINGO':
                // Tópico 5: Interactive Bingo usa a imagem para acionar o modal
                questionText.innerHTML = q.question;
                optionsContainer.innerHTML = '';
                optionsContainer.style.display = 'none';
                break;
            case 'FILL_IN_BLANKS':
                loadFillInBlanks(q);
                break;
            case 'DRAG_AND_DROP':
                loadDragAndDrop(q);
                break;
            default: // Múltipla escolha (Quiz)
                loadQuizSlide(q);
                break;
        }
        // Lida com a visibilidade dos botões
        backBtn.textContent = currentQuestionIndex === 0 ? 'Home' : 'Back';
        
        // Para slides de informação, 'Next' é o comportamento padrão. Para exercícios, é 'Check'
        if (['INFO_TABLE', 'PRONUNCIATION_SET', 'INTERACTIVE_BINGO'].includes(q.correctAnswer)) {
            nextBtn.textContent = 'Next';
        } else {
            // Se for um exercício (Drag/Fill-in/Quiz), ele checa primeiro, depois avança
            nextBtn.textContent = answerChecked ? 'Next' : 'Check';
        }
    } // <-- Fim da função loadQuestion

    // Inicializa as funções globais e a tela inicial
    document.addEventListener('DOMContentLoaded', () => {
        // Define as funções globais (necessário para onclicks em elementos HTML)
        window.startLesson = startLesson;
        window.goHome = goHome;
        window.openNav = openNav;
        window.closeNav = closeNav;
        window.goNext = goNext;
        window.backQuestion = backQuestion;
        window.checkAnswer = checkAnswer;
        window.openNumberModal = openNumberModal;
        window.closeNumberModal = closeNumberModal;
        window.playAudio = playAudio;
        window.dragStart = dragStart; // Certifica que dragStart está disponível se for usado no HTML
        window.drop = drop; // Certifica que drop está disponível
        window.returnWordToContainer = returnWordToContainer; // Certifica que o retorno está disponível
    });
    // Garante que a tela inicial é mostrada
    goHome();
    
</script>
